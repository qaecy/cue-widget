import{a as g,b as R}from"./chunk-XY7JJLBZ.js";import{p as w,q as _,r as S,w as l}from"./chunk-5WADEDAY.js";import{Ga as d,Gc as c,fa as u,h as a,ka as p}from"./chunk-Q4ZSJ5ZI.js";function q(r){return a(this,arguments,function*(s,j={},e=t=>console.log(t)){try{let t=yield fetch(s,j);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);if(!t.body)throw new Error("ReadableStream not supported");let i=t.body.getReader(),n=new TextDecoder("utf-8"),o="",m=!1;for(;!m;){let{done:y,value:v}=yield i.read();if(m=y,y){if(o.trim())try{console.log("Final chunk:",o)}catch(f){console.error("Error parsing final chunk:",f)}continue}o+=n.decode(v,{stream:!0});let h;for(;(h=o.indexOf("}"))>=0;){let f=o.substring(0,h+1);o=o.substring(h+1),e(f)}}}catch(t){console.error("Fetch error:",t)}})}var I=(()=>{class s{_service=p(l);_headers=c(()=>{let e=new Headers(this._service.headers());return e.append("Content-Type","application/json"),e});_queryEndpoint=c(()=>this._service.gatewayURL()+_);ready=c(()=>this._service.projectId()!==void 0&&this._service.token()!==void 0);query(e,r="application/sparql-results+json"){return a(this,null,function*(){let t=new Headers(this._headers());t.set("Accept",r),t.set("Content-Type","application/x-www-form-urlencoded");let i=new URLSearchParams;i.append("query",e);let n={method:"POST",headers:t,body:i};return(yield fetch(this._queryEndpoint(),n)).json()})}static \u0275fac=function(r){return new(r||s)};static \u0275prov=u({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})();var J=(()=>{class s{_service=p(l);_file=p(R);_triplestore=p(I);headers=c(()=>{let e=new Headers(this._service.headers());return e.append("Content-Type","application/json"),e});projectId=this._service.projectId;endpoint=c(()=>this._service.gatewayURL()+w);_resultBuffer=d("");searchResults=d([]);info=d("Search your project...");status=d("");properties=[{label:"Keyword",iri:"qcy:tag"},{label:"Summary",iri:"qcy:textSummary"},{label:"Value",iri:"qcy:value"}];_contextMap={};executeSearch(e){return a(this,null,function*(){this.status.set("Executing search..."),this._resultBuffer.set("");let r={method:"POST",headers:this.headers(),body:JSON.stringify({projectId:this.projectId(),question:e.searchTerm,doRerank:e.inDepthMode,useGraph:!0,useVector:e.inDepthMode,limit:25})},t=n=>{this._processChunk(n)};yield q(this.endpoint(),r,t);let i=JSON.parse(this._resultBuffer());this._contextMap={},this.searchResults.update(()=>i.results.map(n=>this._formatResponse(n)))})}getDocumentPayload(e){return a(this,null,function*(){let r=`${S}${this.projectId()}/${this._contextMap[e.id]}`,t={contentIRI:r,path:"",md5:"",page:e.page!==void 0?parseInt(e.page):void 0},i=`PREFIX qcy: <${g.qcy}>
    SELECT ?md5 (SAMPLE(?fp) AS ?filePath)
    WHERE{
      <${r}> qcy:md5Hash ?md5 ;
      qcy:hasFileLocation ?location .
      ?location qcy:filePath ?fp
    } GROUP BY ?md5`,o=(yield this._triplestore.query(i))?.results?.bindings[0];return o===void 0||(t.path=o.filePath.value,t.md5=o.md5.value),t})}_processChunk(e){if(e.includes('"message"')){let r=JSON.parse(e);this.status.set(r.message)}else this._resultBuffer.update(r=>r+=e)}_formatResponse(e){let r=e.name.split(".").pop(),t=e.id.includes("?page=")?e.id.split("?page=")[1]:void 0;return this._contextMap[e.id]=e.context,{id:e.id,name:e.name.split("/").pop()??e.name,tags:Array.isArray(e.tags)?e.tags:e.tags.split(","),summary:e.summary,mime:e.mime,size:parseInt(e.size),page:t,docURL:()=>a(this,null,function*(){return yield this._file.getDownloadURL("raw",`${this.projectId()}/${e.context}.${r}`)})}}static \u0275fac=function(r){return new(r||s)};static \u0275prov=u({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})();export{J as a};
